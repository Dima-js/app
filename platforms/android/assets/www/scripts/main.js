"use strict";function pointsTitle(e){var a=void 0;switch(e.toString().slice(-1)){case"1":a="балл";break;case"2":a="балла";break;case"3":a="балла";break;case"4":a="балла";break;default:a="баллов"}return e>10&&e<15&&(a="баллов"),a}function pagePreloader(){function e(){a.removeAttr("data-active")}var a=$(".appPreloader");return a.attr("data-active",""),e}function backForm(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",o=$(".backForm"),r=o.find(".backForm__prev"),n=o.find(".backForm__title");a?r.attr("data-active",""):r.removeAttr("data-active"),e?(n.text(i),o.attr("data-active","")):(o.removeAttr("data-active"),setTimeout(function(){n.text(i)},300)),r.off().on("click",function(){App.$currPage.removeAttr("data-active"),App.$prevPage.attr("data-active","true"),n.text(s),t||r.removeAttr("data-active"),App.$prevPage.is($(".entryMain"))&&(o.removeAttr("data-active"),wrapperActive(!1))})}function sideBarMenu(){function e(){o.toggleClass("active"),n.toggleClass("active"),""===s.attr("data-active")?s.removeAttr("data-active"):s.attr("data-active","")}var a=$(".entryMain"),t=$(".entryLogin"),i=$(".entryReg"),s=$(".backForm"),o=$(".openMenuButton"),r=$(".gymMenuButton"),n=$(".mainSidebarMenu"),l=n.find(".mainSidebarMenu__logOut"),c=n.find(".mainSidebarMenu__layout"),p=n.find(".mainSidebarMenu__list"),d=$(".profileInfo"),m=$(".profileEdit"),u=$(".profileRating"),f=$(".profileBadges"),v=$(".entranceToGym"),g=$(".gymQuests"),_=$(".gymStore");o.attr("data-active",""),o.off().on("click",e),c.off().on("click",e),l.off().on("click",function(s){s.preventDefault(),App.token=void 0,window.localStorage.setItem("access_token",void 0),e(),t.removeAttr("data-active"),i.removeAttr("data-active"),a.attr("data-active","false"),entryMain(),console.dir(App.$prevPage),console.dir(App.$currPage),App.$prevPage.removeAttr("data-active"),App.$currPage.removeAttr("data-active"),o.removeAttr("data-active"),r.removeAttr("data-active"),backForm(!1,!1,!1)}),p.off().on("click","li",function(){var a=$(this),t=a.attr("data-item"),i=void 0;switch(e(),t){case"info":i=App.$currPage,i.is(d)||i.removeAttr("data-active"),profileInfo();break;case"rating":d.attr("data-active","false"),i=App.$currPage,i.is(u)||(i.is(d)?i.attr("data-active","false"):(i.attr("data-active","false"),setTimeout(function(){i.removeAttr("data-active")},700))),profileRating();break;case"quests":d.attr("data-active","false"),i=App.$currPage,i.is(g)||(i.is(v)||(i.is(d)?i.attr("data-active","false"):(i.attr("data-active","false"),setTimeout(function(){i.removeAttr("data-active")},700))),checkGymEntry(gymQuests));break;case"badges":d.attr("data-active","false"),i=App.$currPage,i.is(f)||(i.is(d)?i.attr("data-active","false"):(i.attr("data-active","false"),setTimeout(function(){i.removeAttr("data-active")},700))),profileBadges();break;case"edit":d.attr("data-active","false"),i=App.$currPage,i.is(m)||(i.is(d)?i.attr("data-active","false"):(i.attr("data-active","false"),setTimeout(function(){i.removeAttr("data-active")},700))),profileEdit();break;case"shop":d.attr("data-active","false"),i=App.$currPage,i.is(_)||(i.is(v)||(i.is(d)?i.attr("data-active","false"):(i.attr("data-active","false"),setTimeout(function(){i.removeAttr("data-active")},700))),checkGymEntry(gymStore))}})}function wrapperActive(e){var a=$(".wrapper");e?a.attr("data-active",""):a.removeAttr("data-active")}function showApp(){var e=$(".app");e.attr("data-visible","")}function getProfileData(e){var a=$(".csLoader"),t=$.ajax({type:"GET",url:"/api/v1/profile?updated_at="+App.profileStorage.updated_at,dataType:"json",xhrFields:{withCredentials:!0},beforeSend:function(){a.attr("data-active","")},success:function(){console.log("profileInfo ajax success")},error:function(){console.log("profileInfo ajax error")}}),i=$.ajax({type:"GET",url:"/api/v1/rating?updated_at="+App.ratingLatestChange,dataType:"json",xhrFields:{withCredentials:!0},beforeSend:function(){a.attr("data-active","")},success:function(){console.log("rating ajax success")},error:function(){console.log("rating ajax error")}}),s=$.ajax({type:"GET",url:"/api/v1/badges?updated_at="+App.badgesLatestChange,dataType:"json",xhrFields:{withCredentials:!0},beforeSend:function(){a.attr("data-active","")},success:function(){console.log("badges ajax success")},error:function(){console.log("badges ajax error")}});$.when(t,i,s).always(function(){a.removeAttr("data-active")}),$.when(t,i,s).done(function(a,t,i){var s=!1;"data"in a[0]&&(App.profileStorage=$.extend(!0,{},a[0].data),enterProfileInfo(),s=!0),"data"in t[0]&&(App.ratingStorage=$.extend(!0,{},t[0].data),enterProfileRating(),s=!0),"data"in i[0]&&(App.badgesStorage=$.extend(!0,{},i[0].data),enterProfileBadges(),s=!0),s&&(setTimeout(function(){pagePreloader()(),showApp()},2e3),backForm(!0,!1,!1,App.profileStorage.full_name,"")),e()})}function enterProfileInfo(){var e=$(".profileInfo"),a=e.find(".profileInfo__questsNum"),t=e.find(".profileInfo__photo"),i=$(".mainSidebarMenu"),s=i.find(".mainSidebarMenu__name"),o=i.find(".mainSidebarMenu__points"),r=i.find(".mainSidebarMenu__photo"),n=e.find(".profileInfo__badgesNum"),l=e.find(".profileInfo__points"),c=e.find(".profileInfo__rating"),p=$(".gymStore__balancePoints");console.dir(App.profileStorage),s.text(App.profileStorage.full_name),a.text(App.profileStorage.quests),t.empty().append('<img src="'+App.profileStorage.image+'" alt="Profile Logo">'),r.empty().append('<img src="'+App.profileStorage.image+'" alt="Profile Logo">'),n.text(App.profileStorage.badges),l.empty().append("<span>"+App.profileStorage.points+"</span>"+pointsTitle(App.profileStorage.points)),o.empty().append("<span>"+App.profileStorage.points+"</span>"+pointsTitle(App.profileStorage.points)),p.empty().append("<span>"+App.profileStorage.points+"</span>"+pointsTitle(App.profileStorage.points)),c.find("span").text(App.profileStorage.rating)}function enterProfileRating(){var e=$(".profileRating"),a=e.find(".profileRating__list");console.log("rating ajax success"),a.empty(),$.each(App.ratingStorage,function(e,t){var i=void 0;i=t.id!==App.profileStorage.id?$('<li class="profileRating__item ratingItem"><div class="ratingItem__photo"><img src="'+t.image+'" alt="Profile'+e+'1"></div><div class="ratingItem__info"><div class="ratingItem__name">'+t.full_name+'</div><div class="ratingItem__points"><span>'+t.points+"</span> "+pointsTitle(t.points)+"</div></div></li>"):$('<li class="profileRating__item ratingItem" data-self><div class="ratingItem__photo"><img src="'+t.image+'" alt="Profile'+e+'1"></div><div class="ratingItem__info"><div class="ratingItem__name">'+t.full_name+'</div><div class="ratingItem__points"><span>'+t.points+"</span> "+pointsTitle(t.points)+'</div><div class="ratingItem__lvlUp mediumRedButton">Подняться в рейтинге</div></div></li>');var s=new Date(App.ratingLatestChange),o=new Date(t.updated_at);s<o&&(App.ratingLatestChange=t.updated_at),a.append(i)})}function enterProfileBadges(){var e=$(".profileBadges__list");console.log("badges ajax success"),e.empty(),$.each(App.badgesStorage,function(a,t){var i=$('<li class="profileBadges__item profileBadgesItem"><div class="profileBadgesItem__main"><div class="profileBadgesItem__photo"><div class="profileBadgesItem__photoWrapper"><img src="'+t.image+'" alt="Badg'+a+'1"></div></div><div class="profileBadgesItem__info"><div class="profileBadgesItem__title">'+t.title+'</div><div class="profileBadgesItem__desc">'+t.desc+'</div></div></div><div class="profileBadgesItem__subMain"><div class="profileBadgesItem__text">'+t.text+'</div><div class="profileBadgesItem__social socialBlock socialBlock--quests"><div class="socialBlock__title socialBlock__title--quests">Поделиться:</div><ul class="socialBlock__list"><li class="socialBlock__item"><a href="#"><i class="icon-fb"></i></a></li><li class="socialBlock__item"><a href="#"><i class="icon-tw"></i></a></li></ul></div></div></li>'),s=new Date(App.badgesLatestChange),o=new Date(t.updated_at);s<o&&(App.badgesLatestChange=t.updated_at),e.append(i)})}function entryMain(){var e=$(".entryMain"),a=e.find(".entryMain__signIn"),t=e.find(".entryMain__signOut");wrapperActive(!1),e.attr("data-active","true"),setTimeout(function(){pagePreloader()(),showApp()},2e3),a.off().on("click",function(a){a.preventDefault(),wrapperActive(!0),e.attr("data-active","false"),entryLogin()}),t.off().on("click",function(a){a.preventDefault(),wrapperActive(!0),e.attr("data-active","false"),entryReg()})}function entryLogin(){var e=$(".csLoader"),a=$(".entryMain"),t=$(".entryLogin"),i=t.find(".entryLogin__form"),s=t.find(".entryLogin__passRecovery"),o=t.find(".entryLogin__newPass"),r=t.find(".entryLoginForm__input"),n=i.find('input[name="username"]'),l=i.find('input[name="password"]'),c=i.find(".entryLoginForm__forgotPass");App.$prevPage=a,App.$currPage=t,t.attr("data-active","true"),backForm(!0,!0,!0,"Авторизация"),i.attr("data-active",""),s.removeAttr("data-active"),o.removeAttr("data-active"),n.off().on("keyup",function(){$(this).val($(this).val().replace(/[^0-9]+$/g,""))}),n.on("focus",function(){r.removeClass("error")}),l.on("focus",function(){r.removeClass("error")}),c.off().on("click",function(){i.removeAttr("data-active"),s.attr("data-active",""),setTimeout(function(){backForm(!0,!0,!0,"Восстановление пароля")},100)}),i.off().on("submit",function(a){var t=n.val(),s=l.val();a.preventDefault(),""===n.val().replace(/\s/g,"")||""===l.val().replace(/\s/g,"")?r.addClass("error"):$.ajax({type:"POST",url:"/api/v1/auth/login",dataType:"json",data:{subscriber_number:t,password:s},xhrFields:{withCredentials:!0},beforeSend:function(){e.attr("data-active","")},success:function(e){App.token=e.token,window.localStorage.setItem("access_token",App.token),$.ajaxSetup({headers:{Authorization:"Token "+App.token}}),profileInfo(),console.log("logIn ajax success")},error:function(){i.find(".entryLoginForm__input").addClass("error"),e.removeAttr("data-active"),console.log("Log in - error")}})}),recoveryPage()}function validateEmail(e){var a=/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i;return a.test(e)}function recoveryPage(){var e=$(".csLoader"),a=$(".entryLogin"),t=a.find(".entryLogin__form"),i=a.find(".entryLogin__passRecovery"),s=i.find(".passRecoveryForm__input"),o=s.find('input[name="rec-aboniment"]');o.off().on("keyup",function(){$(this).val($(this).val().replace(/[^0-9]+$/g,""))}),o.on("focus",function(){s.removeClass("error")}),i.off().on("submit",function(a){var r=o.val();a.preventDefault(),r?$.ajax({type:"POST",url:"/api/v1/auth/restore",dataType:"json",data:{subscriber_number:parseInt(r)},xhrFields:{withCredentials:!0},beforeSend:function(){e.attr("data-active","")},success:function(e){function a(){i.removeAttr("data-active"),t.attr("data-active",""),setTimeout(function(){backForm(!0,!0,!0,"Авторизация")},100)}var r=e.status,n=e.message;switch(r){case"success":popUp("Восстановление пароля",n,"На главную",$(""),a),o.val("");break;case"error":popUp("Восстановление пароля",n,"Закрыть"),s.addClass("error")}console.log("recovery ajax success")},error:function(){console.log("recovery ajax error")},complete:function(){e.removeAttr("data-active")}}):s.addClass("error")})}function entryReg(){var a=$(".csLoader"),t=$(".entryMain"),i=$(".entryReg"),s=i.find(".entryReg__form"),o=s.find(".editPhoto__wrapper"),r=s.find('input[name="reg-image"]'),n=s.find('input[name="reg-name"]'),l=s.find('input[name="reg-mail"]'),c=s.find('input[name="reg-aboniment"]'),p=s.find('input[name="reg-new-pass"]'),d=s.find('input[name="reg-confirm-pass"]'),m=s.find(".editPhoto__removePhoto");App.$prevPage=t,App.$currPage=i,i.attr("data-active","true"),backForm(!0,!0,!0,"Регистрация"),n.on("focus",function(){var e=$(this),a=e.parent();a.removeClass("error")}),l.on("focus",function(){var e=$(this),a=e.parent();a.removeClass("error")}),c.on("focus",function(){var e=$(this),a=e.parent();a.removeClass("error")}),p.on("focus",function(){var e=$(this),a=e.parent();a.removeClass("error")}),d.on("focus",function(){var e=$(this),a=e.parent();a.removeClass("error")}),l.on("keyup",function(){var e=$(this),a=e.parent();setTimeout(function(){e.val()?validateEmail(e.val())?a.removeClass("error"):a.addClass("error"):a.removeClass("error")},2e3)}),c.on("keyup",function(){$(this).val($(this).val().replace(/[^0-9]+$/g,""))}),p.on("keyup",function(){var e=$(this),a=e.parent(),t=d.parent();setTimeout(function(){e.val()?d.val()&&(e.val()!==d.val()?a.addClass("error"):(a.removeClass("error"),t.removeClass("error"))):a.removeClass("error")},1500)}),d.on("keyup",function(){var e=$(this),a=p.parent(),t=e.parent();setTimeout(function(){e.val()?p.val()&&(e.val()!==p.val()?t.addClass("error"):(a.removeClass("error"),t.removeClass("error"))):t.removeClass("error")},1500)}),r.change(function(){if($(this)[0].files&&$(this)[0].files[0]){var e=$(this),a=new FileReader,t=new Image,i=!0;t.onload=function(a){t.naturalWidth>App.max_upload_image_width&&(popUp("Ошибка",App.messages.lang_errorSelectedImageWidthError,App.messages.lang_close),i=!1),t.naturalHeight>App.max_upload_image_height&&(popUp("Ошибка",App.messages.lang_errorSelectedImageHeightError,App.messages.lang_close),i=!1),e[0].files[0].size>App.max_upload_file_size&&(popUp("Ошибка",App.messages.lang_errorSelectedFileIsTooLarge,App.messages.lang_close),i=!1),i||(o.find(".editPhoto__img").remove(),e.replaceWith(e.val("").clone(!0)))},a.onload=function(e){i&&o.find(".editPhoto__img").remove(),o.append($('<img src="'+e.target.result+'" alt="Profile Logo" class="editPhoto__img"/>')),t.src=e.target.result},a.readAsDataURL(e[0].files[0])}}),m.off().on("click",function(){e.preventDefault(),r.val(""),o.find(".editPhoto__img").remove()}),s.off().on("submit",function(e){function t(){(!n.val()||n.val().length<3)&&n.parent().addClass("error"),l.val()||l.parent().addClass("error"),c.val()||c.parent().addClass("error"),p.val()||p.parent().addClass("error"),d.val()||d.parent().addClass("error"),p.val()!==d.val()&&(p.parent().addClass("error"),d.parent().addClass("error"))}e.preventDefault();var o=new FormData($(this)[0]);t(),s.find(".entryRegForm__input.error").length||$.ajax({type:"POST",url:"/api/v1/auth/register",dataType:"json",data:o,cache:!1,processData:!1,contentType:!1,xhrFields:{withCredentials:!0},beforeSend:function(){a.attr("data-active","")},success:function(){popUp("Регистрацию завершено","Вам на почту отправлено письмо с подтверждением.","Ввойти",i,entryLogin),s.find('input:not(input[name="reg-submit"])').val(""),a.removeAttr("data-active"),console.log("reg ajax success")},error:function(e){var t=$.extend(!0,{},e.responseJSON.validation.message),i="";"full_name"in t&&(n.parent().addClass("error"),i+=t.full_name+"<br/>"),"email"in t&&(l.parent().addClass("error"),i+=t.email+"<br/>"),"subscriber_number"in t&&(c.parent().addClass("error"),i+=t.subscriber_number+"<br/>"),"password"in t&&(p.parent().addClass("error"),i+=t.password+"<br/>"),"password_confirmation"in t&&(d.parent().addClass("error"),i+=t.password_confirmation+"<br/>"),popUp("Ошибка",i,"Закрыть"),a.removeAttr("data-active"),console.log("reg ajax error")}})})}function profileInfo(){var e=$(".entryLogin"),a=$(".profileInfo"),t=a.find(".profileInfo__quests"),i=a.find(".profileInfo__badges"),s=a.find(".profileInfo__rating"),o=a.find(".profileInfo__editButton"),r=a.find(".profileInfo__goStore"),n=$(".gymMenuButton");App.token=window.localStorage.getItem("access_token"),$.ajaxSetup({headers:{Authorization:"Token "+App.token}}),$.ajax({type:"GET",url:"/api/v1/profile",dataType:"json",xhrFields:{withCredentials:!0},success:function(){function l(){wrapperActive(!0),e.attr("data-active","false"),a.attr("data-active","true"),n.attr("data-active",""),sideBarMenu(),t.off().on("click",function(){a.attr("data-active","false"),checkGymEntry(gymQuests)}),i.off().on("click",function(){a.attr("data-active","false"),profileBadges()}),s.off().on("click",function(){a.attr("data-active","false"),profileRating()}),o.off().on("click",function(e){e.preventDefault(),a.attr("data-active","false"),profileEdit()}),r.off().on("click",function(e){e.preventDefault(),a.attr("data-active","false"),checkGymEntry(gymStore)}),n.off().on("click",function(){a.attr("data-active","false");var e=App.$currPage,t=$(".gymQuests"),i=$(".entranceToGym");e.is(t)||(e.is(i)||(e.is(a)?e.attr("data-active","false"):(e.attr("data-active","false"),setTimeout(function(){e.removeAttr("data-active")},700))),checkGymEntry(gymQuests))})}App.$prevPage=a,App.$currPage=a,console.log("profile info success !!!!!!"),getProfileData(l),console.log("token ajax success")},error:function(){entryMain(),console.log("token ajax error")}})}function profileEdit(){var e=$(".csLoader"),a=$(".profileInfo"),t=$(".profileEdit"),i=t.find(".profileEdit__form"),s=t.find(".editPhoto__wrapper"),o=i.find("#f-edit-image"),r=i.find('input[name="edit-hidden"]'),n=i.find('input[name="edit-name"]'),l=i.find('input[name="edit-mail"]'),c=i.find('input[name="edit-aboniment"]'),p=i.find('input[name="edit-old-pass"]'),d=i.find('input[name="edit-new-pass"]'),m=i.find('input[name="edit-confirm-pass"]'),u=i.find(".editPhoto__removePhoto");App.$prevPage=a,App.$currPage=t,s.append('<img src="'+App.profileStorage.image+'" alt="Photo Profile" class="editPhoto__img">'),r.val(App.profileStorage.avatar),n.val(App.profileStorage.full_name),l.val(App.profileStorage.email),c.val(App.profileStorage.subscriber_number),d.prop("disabled",!0),m.prop("disabled",!0),t.attr("data-active","true"),backForm(!0,!0,!1,"Редактировать профиль",App.profileStorage.full_name),n.on("focus",function(){var e=$(this),a=e.parent();a.removeClass("error")}),l.on("focus",function(){var e=$(this),a=e.parent();a.removeClass("error")}),c.on("focus",function(){var e=$(this),a=e.parent();a.removeClass("error")}),p.on("focus",function(){var e=$(this),a=e.parent();a.removeClass("error")}),d.on("focus",function(){var e=$(this),a=e.parent();a.removeClass("error")}),m.on("focus",function(){var e=$(this),a=e.parent();a.removeClass("error")}),l.on("keyup",function(){var e=$(this),a=e.parent();setTimeout(function(){e.val()?validateEmail(e.val())?a.removeClass("error"):a.addClass("error"):a.removeClass("error")},2e3)}),c.on("keyup",function(){$(this).val($(this).val().replace(/[^0-9]+$/g,""))}),p.on("keyup",function(){var e=$(this);e.val()?(d.prop("disabled",!1),m.prop("disabled",!1)):(d.prop("disabled",!0),m.prop("disabled",!0))}),d.on("keyup",function(){var e=$(this),a=e.parent(),t=m.parent();setTimeout(function(){e.val()?m.val()&&(e.val()!==m.val()?a.addClass("error"):(a.removeClass("error"),t.removeClass("error"))):a.removeClass("error")},1500)}),m.on("keyup",function(){var e=$(this),a=d.parent(),t=e.parent();setTimeout(function(){e.val()?d.val()&&(e.val()!==d.val()?t.addClass("error"):(a.removeClass("error"),t.removeClass("error"))):t.removeClass("error")},1500)}),i.off().on("submit",function(a){function s(){(!n.val()||n.val().length<3)&&n.parent().addClass("error"),l.val()||l.parent().addClass("error"),p.val()&&(d.val()||d.parent().addClass("error"),m.val()||m.parent().addClass("error"),d.val()!==m.val()&&(d.parent().addClass("error"),m.parent().addClass("error")))}a.preventDefault();var o=new FormData($(this)[0]);s(),i.find(".entryRegForm__input.error").length||$.ajax({type:"POST",url:"/api/v1/profile",dataType:"json",data:o,cache:!1,processData:!1,contentType:!1,xhrFields:{withCredentials:!0},beforeSend:function(){e.attr("data-active","")},success:function(){popUp("Сохранено","Данные были успешно изменены.","Профиль",t,profileInfo),p.val(""),d.val(""),m.val(""),e.removeAttr("data-active"),console.log("reg ajax success")},error:function(a){var t=$.extend(!0,{},a.responseJSON.validation.message),i="";"full_name"in t&&(n.parent().addClass("error"),i+=t.full_name+"<br/>"),"email"in t&&(l.parent().addClass("error"),i+=t.email+"<br/>"),"subscriber_number"in t&&(c.parent().addClass("error"),i+=t.subscriber_number+"<br/>"),"old_password"in t&&(p.parent().addClass("error"),i+=t.old_password+"<br/>"),"password"in t&&(d.parent().addClass("error"),i+=t.password+"<br/>"),"password_confirmation"in t&&(m.parent().addClass("error"),i+=t.password_confirmation+"<br/>"),popUp("Ошибка",i,"Закрыть"),e.removeAttr("data-active"),console.log("reg ajax error")}})}),o.change(function(){if($(this)[0].files&&$(this)[0].files[0]){var e=$(this),a=new FileReader,t=new Image,i=!0;t.onload=function(a){t.naturalWidth>App.max_upload_image_width&&(popUp("Ошибка",App.messages.lang_errorSelectedImageWidthError,App.messages.lang_close),i=!1),t.naturalHeight>App.max_upload_image_height&&(popUp("Ошибка",App.messages.lang_errorSelectedImageHeightError,App.messages.lang_close),i=!1),e[0].files[0].size>App.max_upload_file_size&&(popUp("Ошибка",App.messages.lang_errorSelectedFileIsTooLarge,App.messages.lang_close),i=!1),i||(s.find(".editPhoto__img").remove(),e.replaceWith(e.val("").clone(!0)))},a.onload=function(e){i&&s.find(".editPhoto__img").remove(),s.append($('<img src="'+e.target.result+'" alt="Profile Logo" class="editPhoto__img"/>')),t.src=e.target.result},a.readAsDataURL(e[0].files[0])}}),u.off().on("click",function(e){e.preventDefault(),o.val(""),r.val(""),i.find(".editPhoto__img").remove()})}function profileRating(){var e=$(".profileInfo"),a=$(".profileRating"),t=a.find(".profileRating__list"),i=a.find(".ratingItem__lvlUp");App.$prevPage=e,App.$currPage=a,backForm(!0,!0,!1,"Рейтинг",App.profileStorage.full_name),a.attr("data-active","true"),i.off().on("click",function(){a.attr("data-active","false"),checkGymEntry(gymQuests)});var s=t.find(".profileRating__item[data-self]");a.scrollTop(0).scrollTop(s.offset().top-2*s.height())}function profileBadges(){var e=$(".profileInfo"),a=$(".profileBadges"),t=a.find(".profileBadges__list");App.$prevPage=e,App.$currPage=a,backForm(!0,!0,!1,"Мои бейджи",App.profileStorage.full_name),a.attr("data-active","true"),t.off().on("click","li",function(){var e=$(this),a=e.siblings();a.find(".profileBadgesItem__subMain").slideUp("slow"),e.find(".profileBadgesItem__subMain").slideToggle("slow")})}function checkGymEntry(e){var a=$(".csLoader");$.ajax({type:"GET",url:"/api/v1/auth/gym/check-access",dataType:"json",xhrFields:{withCredentials:!0},beforeSend:function(){a.attr("data-active","")},success:function(){enterToGym(e),console.log("check gym entry success")},error:function(){entranceToGym(e),a.removeAttr("data-active"),console.log("check gym entry error")}})}function enterToGym(e){var a=$(".csLoader"),t=$(".entranceToGym"),i=$(".gymQuests"),s=$(".gymStore"),o=$.ajax({type:"GET",url:"/api/v1/quests/public?updated_at="+App.questsCommonLatestChange,dataType:"json",xhrFields:{withCredentials:!0},beforeSend:function(){a.attr("data-active","")},success:function(){console.log("commonQuests ajax success")},error:function(){console.log("commonQuests ajax error")}}),r=$.ajax({type:"GET",url:"/api/v1/quests/personal?updated_at="+App.questsPersonalLatestChange,dataType:"json",xhrFields:{withCredentials:!0},beforeSend:function(){a.attr("data-active","")},success:function(){console.log("personalQuests ajax success")},error:function(){console.log("personalQuests ajax error")}}),n=$.ajax({type:"GET",url:"/api/v1/shop?updated_at="+App.gymStorageLatestChange,dataType:"json",xhrFields:{withCredentials:!0},beforeSend:function(){a.attr("data-active","")},success:function(){console.log("gymStore ajax success")},error:function(){console.log("gymStore ajax error")}});$.when(o,r,n).always(function(){a.removeAttr("data-active")}),$.when(o,r,n).done(function(a,o,r){var n=!1;"data"in a[0]?(App.questsCommonStorage=$.extend(!0,{},a[0].data),enterQuestsCommon(),n=!0):n=!1,"data"in o[0]?(App.questsPersonalStorage=$.extend(!0,{},o[0].data),enterQuestsPersonal(),n=!0):n=!1,"data"in r[0]?(App.gymStorage=$.extend(!0,{},r[0].data),enterGymStore(),n=!0):n=!1,n&&(t.attr("data-active","false"),i.removeAttr("data-active"),s.removeAttr("data-active")),e()})}function enterQuestsCommon(){var e=$(".gymQuests"),a=e.find('.gymQuests__list[data-list="common"]');a.empty(),$.each(App.questsCommonStorage,function(e,t){var i=void 0;switch(t.status){case 0:i=$('<li class="gymQuests__item gymQuestsItem" data-id="'+t.id+'"><div class="gymQuestsItem__main"><div class="gymQuestsItem__photo"><div class="gymQuestsItem__photoWrapper"><img src="'+t.image+'" alt="Quest'+e+'1"></div></div><div class="gymQuestsItem__info"><div class="gymQuestsItem__title">'+t.title+'</div><div class="gymQuestsItem__desc"><span>+'+t.points+"</span>"+pointsTitle(t.points)+'</div></div></div><div class="gymQuestsItem__subMain"><div class="gymQuestsItem__text">'+t.description+'</div><div class="gymQuestsItem__social socialBlock socialBlock--quests"><div class="socialBlock__title socialBlock__title--quests">Поделиться:</div><ul class="socialBlock__list"><li class="socialBlock__item"><a href="#"><i class="icon-fb"></i></a></li><li class="socialBlock__item"><a href="#"><i class="icon-tw"></i></a></li></ul></div><a href="#" class="gymQuestsItem__passQuest largeRedButton">Пройти квест</a></div></li>');break;case 1:i=$('<li class="gymQuests__item gymQuestsItem" data-id="'+t.id+'"><div class="gymQuestsItem__main"><div class="gymQuestsItem__photo"><div class="gymQuestsItem__photoWrapper"><img src="'+t.image+'" alt="Quest'+e+'1"></div></div><div class="gymQuestsItem__info"><div class="gymQuestsItem__title">'+t.title+'</div><div class="gymQuestsItem__desc"><span>В процессе!</span></div></div></div><div class="gymQuestsItem__subMain"><div class="gymQuestsItem__text">'+t.description+'</div><div class="gymQuestsItem__social socialBlock socialBlock--quests"><div class="socialBlock__title socialBlock__title--quests">Поделиться:</div><ul class="socialBlock__list"><li class="socialBlock__item"><a href="#"><i class="icon-fb"></i></a></li><li class="socialBlock__item"><a href="#"><i class="icon-tw"></i></a></li></ul></div></div></li>');break;case 2:i=$('<li class="gymQuests__item gymQuestsItem" data-id="'+t.id+'" data-done><div class="gymQuestsItem__main"><div class="gymQuestsItem__photo"><div class="gymQuestsItem__photoWrapper"><img src="'+t.image+'" alt="Quest'+e+'1"></div></div><div class="gymQuestsItem__info"><div class="gymQuestsItem__title">'+t.title+'</div><div class="gymQuestsItem__desc"><span>Квест пройден!</span></div></div></div><div class="gymQuestsItem__subMain"><div class="gymQuestsItem__text">'+t.description+'</div><div class="gymQuestsItem__social socialBlock socialBlock--quests"><div class="socialBlock__title socialBlock__title--quests">Поделиться:</div><ul class="socialBlock__list"><li class="socialBlock__item"><a href="#"><i class="icon-fb"></i></a></li><li class="socialBlock__item"><a href="#"><i class="icon-tw"></i></a></li></ul></div></div></li>')}var s=new Date(App.questsCommonLatestChange),o=new Date(t.updated_at);s<o&&(App.questsCommonLatestChange=t.updated_at),a.append(i)})}function enterQuestsPersonal(){var e=$(".gymQuests"),a=e.find('.gymQuests__list[data-list="personal"]');a.empty(),$.each(App.questsPersonalStorage,function(e,t){var i=void 0;switch(t.status){case 0:i=$('<li class="gymQuests__item gymQuestsItem" data-id="'+t.id+'"><div class="gymQuestsItem__main"><div class="gymQuestsItem__photo"><div class="gymQuestsItem__photoWrapper"><img src="'+t.image+'" alt="Quest'+e+'1"></div></div><div class="gymQuestsItem__info"><div class="gymQuestsItem__title">'+t.title+'</div><div class="gymQuestsItem__desc"><span>+'+t.points+"</span>"+pointsTitle(t.points)+'</div></div></div><div class="gymQuestsItem__subMain"><div class="gymQuestsItem__text">'+t.description+'</div><div class="gymQuestsItem__social socialBlock socialBlock--quests"><div class="socialBlock__title socialBlock__title--quests">Поделиться:</div><ul class="socialBlock__list"><li class="socialBlock__item"><a href="#"><i class="icon-fb"></i></a></li><li class="socialBlock__item"><a href="#"><i class="icon-tw"></i></a></li></ul></div><a href="#" class="gymQuestsItem__passQuest largeRedButton">Пройти квест</a></div></li>');break;case 1:i=$('<li class="gymQuests__item gymQuestsItem" data-id="'+t.id+'"><div class="gymQuestsItem__main"><div class="gymQuestsItem__photo"><div class="gymQuestsItem__photoWrapper"><img src="'+t.image+'" alt="Quest'+e+'1"></div></div><div class="gymQuestsItem__info"><div class="gymQuestsItem__title">'+t.title+'</div><div class="gymQuestsItem__desc"><span>В процессе!</span></div></div></div><div class="gymQuestsItem__subMain"><div class="gymQuestsItem__text">'+t.description+'</div><div class="gymQuestsItem__social socialBlock socialBlock--quests"><div class="socialBlock__title socialBlock__title--quests">Поделиться:</div><ul class="socialBlock__list"><li class="socialBlock__item"><a href="#"><i class="icon-fb"></i></a></li><li class="socialBlock__item"><a href="#"><i class="icon-tw"></i></a></li></ul></div></div></li>');break;case 2:i=$('<li class="gymQuests__item gymQuestsItem" data-id="'+t.id+'" data-done><div class="gymQuestsItem__main"><div class="gymQuestsItem__photo"><div class="gymQuestsItem__photoWrapper"><img src="'+t.image+'" alt="Quest'+e+'1"></div></div><div class="gymQuestsItem__info"><div class="gymQuestsItem__title">'+t.title+'</div><div class="gymQuestsItem__desc"><span>Квест пройден!</span></div></div></div><div class="gymQuestsItem__subMain"><div class="gymQuestsItem__text">'+t.description+'</div><div class="gymQuestsItem__social socialBlock socialBlock--quests"><div class="socialBlock__title socialBlock__title--quests">Поделиться:</div><ul class="socialBlock__list"><li class="socialBlock__item"><a href="#"><i class="icon-fb"></i></a></li><li class="socialBlock__item"><a href="#"><i class="icon-tw"></i></a></li></ul></div></div></li>')}var s=new Date(App.questsPersonalLatestChange),o=new Date(t.updated_at);s<o&&(App.questsPersonalLatestChange=t.updated_at),a.append(i)})}function enterGymStore(){var e=$(".gymStore"),a=e.find(".gymStore__nameListWrapper"),t=e.find(".gymStore__contentList");a.slick("removeSlide",null,null,!0),t.slick("removeSlide",null,null,!0),$.each(App.gymStorage,function(e,i){var s=void 0,o=void 0;s=$('<li class="gymStore__nameItem" data-id="'+i.id+'">'+i.name+"</li>"),o=$('<li class="gymStore__contentItem" data-id="'+i.id+'"><img src="'+i.image+'" alt="Product-'+i.id+'"></li>'),a.slick("slickAdd",s),t.slick("slickAdd",o);var r=new Date(App.gymStorageLatestChange),n=new Date(i.updated_at);r<n&&(App.gymStorageLatestChange=i.updated_at)})}function entranceToGym(e){var a=$(".csLoader"),t=$(".profileInfo"),i=$(".entranceToGym"),s=i.find(".entranceToGym__form"),o=i.find(".entranceToGymForm__input"),r=s.find('input[type="text"]'),n=$(".gymQuests"),l=$(".gymStore");App.$prevPage=t,App.$currPage=i,backForm(!0,!0,!1,"Вход в зал",App.profileStorage.full_name),i.attr("data-active","true"),n.removeAttr("data-active"),l.removeAttr("data-active"),r.on("click",function(){$(this).select(),o.removeClass("error")}),r.on("keyup",function(){var e=$(this);2===e.val().length&&$(this).parent().next().find("input").focus().select()}),s.off().on("submit",function(t){var i=o.find('input[name="f-entInput-1"]').val(),s=o.find('input[name="f-entInput-2"]').val(),r=o.find('input[name="f-entInput-3"]').val(),n=o.find('input[name="f-entInput-4"]').val(),l=i+s+r+n;t.preventDefault(),i&&s&&r&&n?$.ajax({type:"POST",url:"/api/v1/auth/gym/login",dataType:"json",data:{code:l},xhrFields:{withCredentials:!0},beforeSend:function(){a.attr("data-active","")},success:function(a){console.log("gymAuth ajax success"),enterToGym(e)},error:function(){o.addClass("error"),console.log("gymAuth ajax error")},complete:function(){a.removeAttr("data-active")}}):o.addClass("error")})}function gymQuests(){var e=$(".csLoader"),a=$(".profileInfo"),t=$(".gymQuests"),i=t.find(".gymQuests__chooseLine"),s=t.find(".gymQuests__chooseList"),o=s.find('.gymQuests__chooseItem[data-choose="common"]'),r=s.find('.gymQuests__chooseItem[data-choose="personal"]'),n=t.find('.gymQuests__list[data-list="common"]'),l=t.find(".gymQuests__lists"),c=t.find('.gymQuests__list[data-list="personal"]');
App.$prevPage=a,App.$currPage=t,backForm(!0,!0,!1,"Квесты",App.profileStorage.full_name),t.attr("data-active","true"),i.attr("data-choose","1"),o.attr("data-active",""),r.removeAttr("data-active"),n.attr("data-active",""),c.removeAttr("data-active",""),o.off().on("click",function(){i.attr("data-choose","1"),o.attr("data-active",""),r.removeAttr("data-active"),n.attr("data-active",""),c.removeAttr("data-active")}),r.off().on("click",function(){i.attr("data-choose","2"),r.attr("data-active",""),o.removeAttr("data-active"),c.attr("data-active",""),n.removeAttr("data-active")}),n.off().on("click","li",function(){var e=$(this),a=e.siblings();a.find(".gymQuestsItem__subMain").slideUp("slow"),e.find(".gymQuestsItem__subMain").slideToggle("slow")}),c.off().on("click","li",function(){var e=$(this),a=e.siblings();a.find(".gymQuestsItem__subMain").slideUp("slow"),e.find(".gymQuestsItem__subMain").slideToggle("slow")}),l.off().on("click",".gymQuestsItem__passQuest",function(a){var t=$(this),i=t.closest(".gymQuests__item"),s=i.find(".gymQuestsItem__desc"),o=parseInt(i.attr("data-id")),r=t.closest(".gymQuests__list").attr("data-list");a.preventDefault(),$.ajax({type:"POST",url:"api/v1/quests/start",dataType:"json",data:{quest_id:o},xhrFields:{withCredentials:!0},beforeSend:function(){e.attr("data-active","")},success:function(e){switch(e.data.status){case"success":switch(r){case"common":for(var a=0;a<App.questsCommonStorage.length;a++)App.questsCommonStorage[a].id===o&&(App.questsCommonStorage[a].status=1);break;case"personal":for(var n=0;n<App.questsPersonalStorage.length;n++)App.questsPersonalStorage[n].id===o&&(App.questsPersonalStorage[n].status=1)}console.dir(t),console.dir(i),console.dir(s),s.empty().append("<span>В процессе!</span>"),t.remove(),popUp("В процессе",e.data.message,"Закрыть");break;case"error":popUp("Ошибка",e.data.message,"Закрыть")}},error:function(){popUp("Ошибка","Квест не найдено.","Закрыть")},complete:function(){e.removeAttr("data-active")}})})}function gymStore(){var e=$(".csLoader"),a=$(".profileInfo"),t=$(".gymStore"),i=t.find(".gymStore__buyForm"),s=t.find(".gymStore__nameListWrapper"),o=t.find(".buyForm__priceValue"),r=t.find(".buyForm__desc"),n=t.find(".buyForm__counter"),l=n.find(".buyForm__dec"),c=n.find(".buyForm__inc"),p=n.find('input[name="f-buyForm-counter"]');App.$prevPage=a,App.$currPage=t,backForm(!0,!0,!1,"Магазин",App.profileStorage.full_name),o.find("span").remove(),r.find("span").remove(),o.html("<span data-inactive>"+App.gymStorage[s.slick("slickCurrentSlide")].price+"</span>"),r.html("<span data-inactive>"+App.gymStorage[s.slick("slickCurrentSlide")].description+"</span>"),o.find("span").removeAttr("data-inactive"),r.find("span").removeAttr("data-inactive"),s.off().on("afterChange",function(e,a){App.gymStorageCurrentItem=s.slick("slickCurrentSlide")+1,o.find("span").remove(),o.html("<span data-inactive>"+App.gymStorage[s.slick("slickCurrentSlide")].price+"</span>"),o.find("span").removeAttr("data-inactive"),p.val("1")}),l.off().on("click",function(){parseInt(p.val())>1&&(p.val(parseInt(p.val())-1),o.html("<span data-inactive>"+App.gymStorage[s.slick("slickCurrentSlide")].price*parseInt(p.val())+"</span>"),o.find("span").removeAttr("data-inactive"))}),c.off().on("click",function(){parseInt(p.val())<10&&(p.val(parseInt(p.val())+1),o.html("<span data-inactive>"+App.gymStorage[s.slick("slickCurrentSlide")].price*parseInt(p.val())+"</span>"),o.find("span").removeAttr("data-inactive"))}),i.off().on("submit",function(t){t.preventDefault();var i=$(".mainSidebarMenu__points"),s=a.find(".profileInfo__points"),r=$(".gymStore__balancePoints");$.ajax({type:"POST",url:"api/v1/shop/order",dataType:"json",data:{product_id:App.gymStorageCurrentItem,count:parseInt(p.val())},xhrFields:{withCredentials:!0},beforeSend:function(){e.attr("data-active","")},success:function(e){switch(e.data.status){case"success":popUp("Сделано",e.data.message,"Закрыть"),App.profileStorage.points-=parseInt(o.find("span").text()),s.empty().append("<span>"+App.profileStorage.points+"</span>"+pointsTitle(App.profileStorage.points)),i.empty().append("<span>"+App.profileStorage.points+"</span>"+pointsTitle(App.profileStorage.points)),r.empty().append("<span>"+App.profileStorage.points+"</span>"+pointsTitle(App.profileStorage.points));break;case"error":popUp("Ошибка",e.data.message,"Закрыть")}console.log("order ajax success")},error:function(){popUp("Ошибка","Товар не найдено или такого товара не существует.","Закрыть"),console.log("order ajax error")},complete:function(){e.removeAttr("data-active")}})}),t.attr("data-active","true")}function gymStoreInit(){var e=$(".gymStore"),a=e.find(".gymStore__nameListWrapper"),t=e.find(".gymStore__contentList"),i=e.find(".buyForm__priceValue"),s=e.find(".buyForm__desc");a.slick({slidesToShow:3,slidesToScroll:1,infinite:!0,speed:300,centerMode:!0,variableWidth:!0,focusOnSelect:!0,asNavFor:t,dots:!1,arrows:!1}),t.slick({slidesToShow:1,slidesToScroll:1,asNavFor:a,dots:!1,arrows:!1}),a.off().on("beforeChange",function(e,a,t,o){i.find("span").attr("data-inactive",""),s.find("span").attr("data-inactive",""),setTimeout(function(){i.find("span").remove(),s.find("span").remove(),i.html("<span data-inactive>"+App.gymStorage[o].price+"</span>"),s.html("<span data-inactive>"+App.gymStorage[o].description+"</span>"),i.find("span").removeAttr("data-inactive"),s.find("span").removeAttr("data-inactive")},150)})}function popUp(e,a,t){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:$(""),s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(){},o=$(".popUp"),r=o.find(".popUp__title"),n=o.find(".popUp__desc"),l=o.find(".popUp__button"),c=i;r.text(e),n.empty().append(a),l.text(t),o.attr("data-active",""),l.off().on("click",function(e){e.preventDefault(),c.attr("data-active",!1),s(),setTimeout(function(){c.removeAttr("data-active")},700),o.removeAttr("data-active")}),o.off().on("click",".popUp__bgLayout",function(){o.removeAttr("data-active")})}var App={profileStorage:{updated_at:"1970-01-01 00:00:00"},ratingStorage:[],ratingLatestChange:"1970-01-01 00:00:00",badgesStorage:[],badgesLatestChange:"1970-01-01 00:00:00",questsCommonStorage:[],questsCommonLatestChange:"1970-01-01 00:00:00",questsPersonalStorage:[],questsPersonalLatestChange:"1970-01-01 00:00:00",gymStorage:[],gymStorageLatestChange:"1970-01-01 00:00:00",gymStorageCurrentItem:1,token:void 0,$prevPage:void 0,$currPage:void 0,max_upload_file_size:window.max_upload_file_size,max_upload_image_width:window.max_upload_image_width,max_upload_image_height:window.max_upload_image_height,messages:{lang_errorSelectedFileIsTooLarge:window.lang_errorSelectedFileIsTooLarge,lang_errorSelectedImageWidthError:window.lang_errorSelectedImageWidthError,lang_errorSelectedImageHeightError:window.lang_errorSelectedImageHeightError,lang_close:window.lang_close}};$(function(){pagePreloader(),profileInfo(),gymStoreInit()}),$(window).load(function(){});